{
  "entities": {
    "Oficina": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Oficina",
      "type": "object",
      "description": "Represents a mechanical workshop (Oficina).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Oficina entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the Oficina."
        },
        "cnpj": {
          "type": "string",
          "description": "CNPJ (Brazilian company identifier) of the Oficina."
        },
        "address": {
          "type": "string",
          "description": "Address of the Oficina."
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the Oficina."
        },
        "email": {
          "type": "string",
          "description": "Email address of the Oficina.",
          "format": "email"
        },
        "subscriptionPlanId": {
          "type": "string",
          "description": "Reference to SubscriptionPlan. (Relationship: SubscriptionPlan 1:N Oficina)"
        }
      },
      "required": [
        "id",
        "name",
        "cnpj",
        "address",
        "phone",
        "email"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "oficinaId": {
          "type": "string",
          "description": "Reference to Oficina. (Relationship: Oficina 1:N User).  Indicates which Oficina the user belongs to."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Role of the user (e.g., ADMIN, OFICINA)."
        },
        "specialty": {
          "type": "string",
          "description": "Specialty of the mechanic."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of user creation for trial period tracking."
        }
      },
      "required": [
        "id",
        "oficinaId",
        "firstName",
        "lastName",
        "email",
        "role",
        "createdAt"
      ]
    },
    "UserOficinaMapping": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserOficinaMapping",
      "type": "object",
      "description": "Maps a user's UID to their corresponding Oficina ID.",
      "properties": {
        "oficinaId": {
          "type": "string",
          "description": "The ID of the Oficina this user belongs to."
        }
      },
      "required": [
        "oficinaId"
      ]
    },
    "OrdemDeServico": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OrdemDeServico",
      "type": "object",
      "description": "Represents a service order (Ordem de Servi√ßo).",
      "properties": {
        "id": {
          "type": "string"
        },
        "displayId": {
          "type": "string",
          "description": "Human-readable sequential ID for the service order, e.g., '0001'."
        },
        "oficinaId": {
          "type": "string"
        },
        "customer": {
          "type": "string"
        },
        "customerDocumentType": {
          "type": "string",
          "enum": [
            "CPF",
            "CNPJ"
          ]
        },
        "customerCpf": {
          "type": "string"
        },
        "customerCnpj": {
          "type": "string"
        },
        "customerPhone": {
          "type": "string"
        },
        "vehicle": {
          "type": "object",
          "properties": {
            "make": {
              "type": "string"
            },
            "model": {
              "type": "string"
            },
            "year": {
              "type": "number"
            },
            "plate": {
              "type": "string"
            },
            "color": {
              "type": "string"
            }
          },
          "required": [
            "make",
            "model",
            "year",
            "plate"
          ]
        },
        "mechanicId": {
          "type": "string"
        },
        "mechanicName": {
          "type": "string"
        },
        "startDate": {
          "type": "string",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "enum": [
            "PRONTO PARA PAGAMENTO",
            "EM ANDAMENTO",
            "PENDENTE",
            "FINALIZADO"
          ]
        },
        "symptoms": {
          "type": "string"
        },
        "diagnosis": {
          "type": "string"
        },
        "services": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string"
              },
              "quantity": {
                "type": "number"
              },
              "unitPrice": {
                "type": "number"
              }
            }
          }
        },
        "parts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "itemId": {
                "type": "string"
              },
              "code": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "quantity": {
                "type": "number"
              },
              "sale_price": {
                "type": "number"
              }
            }
          }
        },
        "subtotal": {
          "type": "number",
          "description": "The total cost before any discount is applied."
        },
        "discount": {
          "type": "number",
          "description": "The monetary value of the discount applied."
        },
        "total": {
          "type": "number",
          "description": "The final total after any discounts."
        },
        "paymentMethod": {
          "type": "string"
        }
      },
      "required": [
        "id",
        "oficinaId",
        "customer",
        "vehicle",
        "startDate",
        "status",
        "total"
      ]
    },
    "SubscriptionPlan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubscriptionPlan",
      "type": "object",
      "description": "Represents a subscription plan (PRO, PRO+, PREMIUM).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SubscriptionPlan entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the subscription plan (e.g., PRO, PRO+, PREMIUM)."
        },
        "price": {
          "type": "number",
          "description": "Price of the subscription plan per month."
        },
        "maxUsers": {
          "type": "number",
          "description": "Maximum number of users allowed for this plan."
        },
        "aiFeaturesEnabled": {
          "type": "boolean",
          "description": "Indicates whether AI features are enabled for this plan."
        }
      },
      "required": [
        "id",
        "name",
        "price",
        "maxUsers",
        "aiFeaturesEnabled"
      ]
    },
    "VehicleHistory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "VehicleHistory",
      "type": "object",
      "description": "Represents the historical service records of a vehicle.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the VehicleHistory entry."
        },
        "oficinaId": {
          "type": "string",
          "description": "Reference to Oficina. Indicates which Oficina this history belongs to."
        },
        "vehiclePlate": {
          "type": "string",
          "description": "License plate of the vehicle."
        },
        "ordemDeServicoIds": {
          "type": "array",
          "description": "References to OrdemDeServico. (Relationship: OrdemDeServico 1:N VehicleHistory). List of service order IDs related to this vehicle.",
          "items": {
            "type": "string"
          }
        },
        "lastServiceDate": {
          "type": "string",
          "description": "Date of the last service performed on the vehicle.",
          "format": "date-time"
        },
        "notes": {
          "type": "string",
          "description": "Any additional notes or observations about the vehicle's history."
        }
      },
      "required": [
        "id",
        "oficinaId",
        "vehiclePlate"
      ]
    },
    "StockItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StockItem",
      "type": "object",
      "description": "Represents an item in the workshop's inventory.",
      "properties": {
        "id": {
          "type": "string"
        },
        "oficinaId": {
          "type": "string"
        },
        "code": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "category": {
          "type": "string"
        },
        "quantity": {
          "type": "number"
        },
        "min_quantity": {
          "type": "number"
        },
        "cost_price": {
          "type": "number"
        },
        "sale_price": {
          "type": "number"
        }
      },
      "required": [
        "id",
        "oficinaId",
        "name",
        "code",
        "quantity",
        "sale_price"
      ]
    },
    "FinancialTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FinancialTransaction",
      "type": "object",
      "description": "Represents a single financial transaction (income or expense).",
      "properties": {
        "id": {
          "type": "string"
        },
        "oficinaId": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "category": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "IN",
            "OUT"
          ]
        },
        "value": {
          "type": "number"
        },
        "date": {
          "type": "string",
          "format": "date-time"
        },
        "reference_id": {
          "type": "string"
        },
        "reference_type": {
          "type": "string",
          "enum": [
            "OS",
            "STOCK",
            "MANUAL"
          ]
        }
      },
      "required": [
        "id",
        "oficinaId",
        "description",
        "type",
        "value",
        "date"
      ]
    },
    "WhatsappConfig": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WhatsappConfig",
      "type": "object",
      "description": "Stores WhatsApp integration configuration.",
      "properties": {
        "apiKey": {
          "type": "string"
        },
        "senderNumber": {
          "type": "string"
        }
      }
    },
    "PaymentsConfig": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PaymentsConfig",
      "type": "object",
      "description": "Stores payment integration configuration.",
      "properties": {
        "pixKey": {
          "type": "string",
          "description": "The PIX key for receiving subscription payments."
        }
      }
    },
    "Counter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Counter",
      "type": "object",
      "description": "Stores a sequential counter for other entities.",
      "properties": {
        "lastId": {
          "type": "number",
          "description": "The last used sequential ID."
        }
      },
      "required": [
        "lastId"
      ]
    }
  },
  "auth": {
    "providers": []
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserOficinaMapping",
          "schema": {
            "$ref": "#/backend/entities/UserOficinaMapping"
          },
          "description": "Stores a mapping from a user's UID to their Oficina ID for quick lookup.",
          "params": [
            {
              "name": "userId",
              "description": "The UID of the user."
            }
          ]
        }
      },
      {
        "path": "/subscriptionPlans/{subscriptionPlanId}",
        "definition": {
          "entityName": "SubscriptionPlan",
          "schema": {
            "$ref": "#/backend/entities/SubscriptionPlan"
          },
          "description": "Stores subscription plan details (PRO, PRO+, PREMIUM).",
          "params": [
            {
              "name": "subscriptionPlanId",
              "description": "Unique identifier for the subscription plan."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}",
        "definition": {
          "entityName": "Oficina",
          "schema": {
            "$ref": "#/backend/entities/Oficina"
          },
          "description": "Stores Oficina details.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user details. Includes denormalized 'oficinaId' for authorization independence.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "userId",
              "description": "Unique identifier for the User."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/ordensDeServico/{ordemDeServicoId}",
        "definition": {
          "entityName": "OrdemDeServico",
          "schema": {
            "$ref": "#/backend/entities/OrdemDeServico"
          },
          "description": "Stores service order details. Includes denormalized 'oficinaId' for authorization independence.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "ordemDeServicoId",
              "description": "Unique identifier for the OrdemDeServico."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/inventory/{stockItemId}",
        "definition": {
          "entityName": "StockItem",
          "schema": {
            "$ref": "#/backend/entities/StockItem"
          },
          "description": "Stores inventory item details. Includes denormalized 'oficinaId' for authorization independence.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "stockItemId",
              "description": "Unique identifier for the StockItem."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/financialTransactions/{transactionId}",
        "definition": {
          "entityName": "FinancialTransaction",
          "schema": {
            "$ref": "#/backend/entities/FinancialTransaction"
          },
          "description": "Stores financial transaction details. Includes denormalized 'oficinaId' for authorization independence.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "transactionId",
              "description": "Unique identifier for the FinancialTransaction."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/vehicleHistory/{vehicleHistoryId}",
        "definition": {
          "entityName": "VehicleHistory",
          "schema": {
            "$ref": "#/backend/entities/VehicleHistory"
          },
          "description": "Stores vehicle history details. Includes denormalized 'oficinaId' for authorization independence.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "vehicleHistoryId",
              "description": "Unique identifier for the VehicleHistory."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/config/whatsapp",
        "definition": {
          "entityName": "WhatsappConfig",
          "schema": {
            "$ref": "#/backend/entities/WhatsappConfig"
          },
          "description": "Stores WhatsApp integration settings.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/config/payments",
        "definition": {
          "entityName": "PaymentsConfig",
          "schema": {
            "$ref": "#/backend/entities/PaymentsConfig"
          },
          "description": "Stores payment settings.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            }
          ]
        }
      },
      {
        "path": "/oficinas/{oficinaId}/counters/{counterId}",
        "definition": {
          "entityName": "Counter",
          "schema": {
            "$ref": "#/backend/entities/Counter"
          },
          "description": "Stores counters for sequential IDs. e.g., counterId can be 'orders'.",
          "params": [
            {
              "name": "oficinaId",
              "description": "Unique identifier for the Oficina."
            },
            {
              "name": "counterId",
              "description": "Identifier for the counter, e.g., 'orders'."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{uid}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores UIDs of admin users.  Existence of a document at this path grants admin privileges.",
          "params": [
            {
              "name": "uid",
              "description": "User ID of the admin."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure, scalable, and easily maintainable data model for the OSMECH application, focusing on Authorization Independence, Structural Segregation, Access Modeling, and Data Clarity. \n\n**Authorization Independence:** The structure achieves Authorization Independence by denormalizing the `oficinaId` field into the `users`, `ordensDeServico`, and `vehicleHistory` collections. This eliminates the need for `get()` calls to parent documents in security rules, enabling atomic operations (transactions/batches) and simplifying debugging.\n\n**Structural Segregation:** Data with different access needs is segregated into separate collections. For instance, user data is stored in `oficinas/{oficinaId}/users/{userId}`, service orders in `oficinas/{oficinaId}/ordensDeServico/{ordemDeServicoId}`, and vehicle history in `oficinas/{oficinaId}/vehicleHistory/{vehicleHistoryId}`, ensuring each collection has a homogeneous security posture.\n\n**Access Modeling:** The structure adheres to consistent patterns for authorization:\n\n*   **Path-Based Ownership:** User data (`/oficinas/{oficinaId}/users/{userId}`) is organized using hierarchical paths to ensure straightforward ownership-based security rules.\n*   **Membership Map (Not Applicable):** Since roles are defined in the user document, no membership map is used for collaborative access here.\n*   **Global Roles (DBAC):** While roles are stored on the user document directly, a dedicated collection for admin roles (`/roles_admin/{uid}`) is supported, enabling existence-based rules for admin privileges.\n\n**QAPs (Rules are not Filters):** The structure supports secure `list` operations by ensuring that authorization information is available within each document, preventing the need to filter based on external data.\n\n**Data Clarity and Predictability:** The structure employs explicit state modeling with the `status` field in `OrdemDeServico`, predictable schema, and radical consistency with semantic naming conventions (e.g., `oficinaId`, `userId`).\n\n*   **Subscription Plans:** Subscription plan details (`/subscriptionPlans/{subscriptionPlanId}`) are stored in a separate collection.  Oficinas reference these plans using the `subscriptionPlanId` field, supporting the SaaS model.\n"
  }
}
