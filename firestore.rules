rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    // DEVELOPMENT-ONLY OVERRIDE
    // =============================================
    // This block grants open access for the `dev-oficina-id`.
    // It is critical for local development where `request.auth` is null.
    // The Firebase rules engine matches the most specific path first, so this
    // will be used for all dev requests, and production rules below will be ignored for this path.
    match /oficinas/dev-oficina-id/{document=**} {
      allow read, write: if true;
    }
  
    // =============================================
    // HELPER FUNCTIONS (FOR PRODUCTION)
    // =============================================
    function isOficinaMember(oficinaId) {
      // Checks if the requesting user is a member of the workshop.
      // SAFE for get/create/update/delete. UNSAFE for list.
      return request.auth != null && exists(/databases/$(database)/documents/oficinas/$(oficinaId)/users/$(request.auth.uid));
    }

    function isOficinaAdmin(oficinaId) {
      // Checks if the user is an ADMIN for the workshop.
      // SAFE for get/create/update/delete. UNSAFE for list.
      if (request.auth == null) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/oficinas/$(oficinaId)/users/$(request.auth.uid));
      return userDoc.data != null && userDoc.data.role == 'ADMIN';
    }
    
    // =============================================
    // PRODUCTION RULES
    // =============================================
    
    // User-to-workshop mapping for login flow (production)
    match /users/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Rule for the workshop document itself.
    match /oficinas/{oficinaId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if false; // NEVER allow listing all workshops for security.
        allow create: if request.auth != null;
        allow update: if isOficinaAdmin(oficinaId);
    }
    
    // Rules for subcollections within a workshop.
    // The client SDK is responsible for querying ONLY within the user's oficinaId.
    // The list rule here just ensures the user is logged in, which is a valid query.

    match /oficinas/{oficinaId}/users/{userId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if request.auth != null;
        allow create: if isOficinaAdmin(oficinaId) || (request.auth != null && request.auth.uid == userId);
        allow delete: if isOficinaAdmin(oficinaId);
        allow update: if (request.auth != null && request.auth.uid == userId && request.resource.data.role == resource.data.role) || isOficinaAdmin(oficinaId);
    }

    match /oficinas/{oficinaId}/ordensDeServico/{osId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if request.auth != null;
        allow create, update: if isOficinaMember(oficinaId);
        allow delete: if isOficinaMember(oficinaId) && resource.data.status != 'FINALIZADO';
    }
    
    match /oficinas/{oficinaId}/inventory/{itemId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if request.auth != null;
        allow create, update, delete: if isOficinaMember(oficinaId);
    }

    // Admins can read/write single transactions. Any logged-in user can list (UI hides for non-admins).
    match /oficinas/{oficinaId}/financialTransactions/{transactionId} {
        allow get: if isOficinaAdmin(oficinaId);
        allow list: if request.auth != null;
        allow write: if isOficinaAdmin(oficinaId);
    }
    
    match /oficinas/{oficinaId}/vehicleHistory/{historyId} {
      allow get: if isOficinaMember(oficinaId);
      allow list: if request.auth != null;
      allow write: if isOficinaMember(oficinaId);
    }
    
    match /oficinas/{oficinaId}/counters/{counterId} {
      allow read, write: if isOficinaMember(oficinaId);
    }

     match /oficinas/{oficinaId}/config/{configId} {
      allow read, write: if isOficinaAdmin(oficinaId);
    }
  }
}
