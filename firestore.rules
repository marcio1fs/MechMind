/**
 * @file firestore.rules
 * @description Security rules for the OSMECH Firestore database.
 *
 * ## Core Philosophy
 * This ruleset implements a strict multi-tenant security model where data is
 * siloed by a workshop (`Oficina`). Users can only access data belonging to
 * the `Oficina` they are a member of. A global 'admin' role exists for
 * administrative override access across all tenants.
 *
 * ## Data Structure & Multi-Tenancy
 * The data is organized hierarchically. All tenant-specific data is nested
 * under `/oficinas/{oficinaId}`. A top-level `/users/{uid}` collection serves as
 * a fast, secure index to map a user's UID to their `oficinaId`. This prevents
 * slow, insecure queries to determine tenancy.
 *
 * ## Key Security Decisions
 * - **Strict Tenant Isolation**: All rules are designed to prevent any
 *   cross-tenant data access. A user from `oficina_A` can never read, write,
 *   or even know about data from `oficina_B`.
 * - **Global Admin Override**: Users whose UID is present in the `/roles_admin`
 *   collection are granted full access to all data for maintenance and support.
 * - **No Public Listing**: Listing all workshops (`/oficinas`), all global
 *   admins (`/roles_admin`), or all users (`/users`) is explicitly disallowed
 *   to prevent enumeration attacks.
 * - **User-Oficina Mapping**: The `/users/{uid}` mapping is read-only after
 *   creation. This lock-down is critical; a user cannot change their own tenancy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the user has a global admin role.
     * Admin status is conferred by the existence of a document in the
     * `roles_admin` collection with the user's UID as the document ID.
     */
    function isGlobalAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Retrieves the user's assigned `oficinaId` from the top-level user mapping.
     * This is the primary source of truth for a user's tenancy.
     */
    function getOficinaId() {
      let userMapping = get(/databases/$(database)/documents/users/$(request.auth.uid));
      // Ensure the mapping exists and has the required field.
      if (userMapping != null && 'oficinaId' in userMapping.data) {
        return userMapping.data.oficinaId;
      }
      return null;
    }

    /**
     * Returns true if the user is a member of the specified `oficinaId`.
     * This is the cornerstone of the multi-tenant security model.
     */
    function isUserOfOficina(oficinaId) {
      let userOficinaId = getOficinaId();
      return userOficinaId != null && userOficinaId == oficinaId;
    }

    /**
     * Returns true if the user is an 'ADMIN' within their specific Oficina.
     * This function is expensive (2 reads), use it only for write operations.
     */
    function isOficinaAdmin() {
        let userOficinaId = getOficinaId();
        if (userOficinaId == null) {
            return false;
        }
        let userProfile = get(/databases/$(database)/documents/oficinas/$(userOficinaId)/users/$(request.auth.uid));
        return userProfile != null && userProfile.data.role == 'ADMIN';
    }
    
    /**
     * Returns true if the user is an 'ADMIN' of the target `oficinaId` path.
     * This is safer for cross-oficina admin checks.
     */
    function isOficinaAdminForPath(oficinaId) {
       let userProfile = get(/databases/$(database)/documents/oficinas/$(oficinaId)/users/$(request.auth.uid));
       return userProfile != null && userProfile.data.role == 'ADMIN';
    }


    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the standard ownership check.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Returns true if the document being accessed already exists.
     * CRITICAL for all update and delete operations to prevent modifying non-existent data.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    /**
     * Validates that a user is creating their own user document and that the
     * `id` and `oficinaId` fields in the document match the path.
     */
    function isCreatingOwnUserDoc(userId, oficinaId) {
      let isCreatingSelf = isOwner(userId);
      let incomingData = request.resource.data;
      let pathMatchesData = incomingData.id == userId && incomingData.oficinaId == oficinaId;

      return isCreatingSelf && pathMatchesData;
    }

    /**
     * Validates that critical, immutable fields (id, oficinaId) are not changed during an update.
     */
    function hasImmutableUserFields() {
      // This rule ensures that a user cannot change their own 'id' or 'oficinaId'.
      // An admin might be able to change roles, but not the core identifiers.
      return !('id' in request.resource.data) && !('oficinaId' in request.resource.data);
    }

    /**
     * Validates that the `oficinaId` in a newly created document matches the path.
     * Ensures all new data is correctly associated with the parent tenant.
     */
    function isCreatingValidOficinaData(oficinaId) {
      return request.resource.data.oficinaId == oficinaId;
    }

    /**
     * Validates that the `oficinaId` is not being changed on update.
     * Enforces immutability of the tenant relationship.
     */
    function isUpdatingValidOficinaData() {
      return request.resource.data.oficinaId == resource.data.oficinaId;
    }

    /**
     * Validates that the `id` in a newly created Oficina document matches the path.
     */
    function isCreatingValidOficinaDoc(oficinaId) {
      return request.resource.data.id == oficinaId;
    }

    /**
     * Validates that the immutable `id` field in an Oficina document is not changed.
     */
    function hasImmutableOficinaFields() {
      return request.resource.data.id == resource.data.id;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

     /**
     * @description Rules for the user-to-oficina mapping collection. This is a critical,
     * high-security collection that forms the backbone of the multi-tenant model.
     * @path /users/{userId}
     * @allow (get) A user can only read their own mapping document to find their oficinaId.
     * @allow (create) A user can only create their own mapping document during signup.
     * @deny (update, delete) No one can change a user's oficina assignment after creation, except a global admin.
     * @deny (list) Prevents enumeration of all users in the system.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isGlobalAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.keys().hasAll(['oficinaId']);
      allow update: if isGlobalAdmin(); // Only global admins can re-assign users
      allow delete: if isGlobalAdmin(); // Only global admins can delete mappings
    }
    
    /**
     * @description Rules for the admin roles collection.
     * @path /roles_admin/{uid}
     */
    match /roles_admin/{uid} {
      allow get: if isGlobalAdmin();
      allow list: if false;
      allow create: if isGlobalAdmin();
      allow update: if isGlobalAdmin();
      allow delete: if isGlobalAdmin();
    }

    /**
     * @description Rules for public-readable subscription plans.
     * @path /subscriptionPlans/{subscriptionPlanId}
     */
    match /subscriptionPlans/{subscriptionPlanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isGlobalAdmin();
      allow update: if isGlobalAdmin();
      allow delete: if isGlobalAdmin();
    }

    /**
     * @description Rules for the Oficina (workshop/tenant) documents.
     * @path /oficinas/{oficinaId}
     */
    match /oficinas/{oficinaId} {
      allow get: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow list: if false;
      allow create: if isSignedIn() && isCreatingValidOficinaDoc(oficinaId); // Only an authenticated user can create a workshop
      allow update: if (isOficinaAdminForPath(oficinaId) && isExistingDoc() && hasImmutableOficinaFields()) || isGlobalAdmin();
      allow delete: if (isOficinaAdminForPath(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }

    /**
     * @description Rules for user documents, which define roles and link users to an oficina.
     * @path /oficinas/{oficinaId}/users/{userId}
     */
    match /oficinas/{oficinaId}/users/{userId} {
      allow get: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow list: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow create: if isCreatingValidOficinaData(oficinaId) 
                      && request.resource.data.id == userId 
                      && (isOwner(userId) || isOficinaAdminForPath(oficinaId));
      allow update: if (isExistingDoc() && (isOwner(userId) || isOficinaAdminForPath(oficinaId)) && hasImmutableUserFields()) || isGlobalAdmin();
      allow delete: if (isExistingDoc() && (isOwner(userId) || isOficinaAdminForPath(oficinaId))) || isGlobalAdmin();
    }

    /**
     * @description Rules for service order documents within an oficina.
     * @path /oficinas/{oficinaId}/ordensDeServico/{ordemDeServicoId}
     */
    match /oficinas/{oficinaId}/ordensDeServico/{ordemDeServicoId} {
      allow get, list: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow create: if (isUserOfOficina(oficinaId) && isCreatingValidOficinaData(oficinaId)) || isGlobalAdmin();
      allow update: if (isUserOfOficina(oficinaId) && isExistingDoc() && isUpdatingValidOficinaData()) || isGlobalAdmin();
      allow delete: if (isUserOfOficina(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }
    
    /**
     * @description Rules for vehicle history documents within an oficina.
     * @path /oficinas/{oficinaId}/vehicleHistory/{vehicleHistoryId}
     */
    match /oficinas/{oficinaId}/vehicleHistory/{vehicleHistoryId} {
      allow get, list: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow create: if (isUserOfOficina(oficinaId) && isCreatingValidOficinaData(oficinaId)) || isGlobalAdmin();
      allow update: if (isUserOfOficina(oficinaId) && isExistingDoc() && isUpdatingValidOficinaData()) || isGlobalAdmin();
      allow delete: if (isUserOfOficina(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }

    /**
     * @description Rules for inventory item documents within an oficina.
     * @path /oficinas/{oficinaId}/inventory/{stockItemId}
     */
    match /oficinas/{oficinaId}/inventory/{stockItemId} {
      allow get, list: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow create: if (isUserOfOficina(oficinaId) && isCreatingValidOficinaData(oficinaId)) || isGlobalAdmin();
      allow update: if (isUserOfOficina(oficinaId) && isExistingDoc() && isUpdatingValidOficinaData()) || isGlobalAdmin();
      allow delete: if (isUserOfOficina(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }

    /**
     * @description Rules for financial transaction documents within an oficina.
     * @path /oficinas/{oficinaId}/financialTransactions/{transactionId}
     */
    match /oficinas/{oficinaId}/financialTransactions/{transactionId} {
      allow get, list: if isUserOfOficina(oficinaId) || isGlobalAdmin();
      allow create: if (isUserOfOficina(oficinaId) && isCreatingValidOficinaData(oficinaId)) || isGlobalAdmin();
      allow update: if (isUserOfOficina(oficinaId) && isExistingDoc() && isUpdatingValidOficinaData()) || isGlobalAdmin();
      allow delete: if (isUserOfOficina(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }

     /**
     * @description Rules for office-specific configuration documents.
     * @path /oficinas/{oficinaId}/config/{configId}
     */
    match /oficinas/{oficinaId}/config/{configId} {
      allow get, list: if isOficinaAdminForPath(oficinaId) || isGlobalAdmin();
      allow create: if isOficinaAdminForPath(oficinaId) || isGlobalAdmin();
      allow update: if (isOficinaAdminForPath(oficinaId) && isExistingDoc()) || isGlobalAdmin();
      allow delete: if (isOficinaAdminForPath(oficinaId) && isExistingDoc()) || isGlobalAdmin();
    }

    /**
     * @description Rules for counter documents used for sequential IDs.
     * @path /oficinas/{oficinaId}/counters/{counterId}
     */
    match /oficinas/{oficinaId}/counters/{counterId} {
      allow read, write: if isUserOfOficina(oficinaId) || isGlobalAdmin();
    }
  }
}
