rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =============================================
    // HELPER FUNCTIONS
    // =============================================
    // NOTA: Estas funções não podem ser usadas em regras `allow list` porque
    // contêm chamadas `get()` ou `exists()`, que não são permitidas em consultas de coleção.

    function isOficinaMember(oficinaId) {
      if (oficinaId == 'dev-oficina-id') {
        return true;
      }
      return request.auth != null && exists(/databases/$(database)/documents/oficinas/$(oficinaId)/users/$(request.auth.uid));
    }

    function isOficinaAdmin(oficinaId) {
      if (oficinaId == 'dev-oficina-id') {
        return true;
      }
      if (request.auth == null) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/oficinas/$(oficinaId)/users/$(request.auth.uid));
      return userDoc.data != null && userDoc.data.role == 'ADMIN';
    }
    
    // =============================================
    // PRODUCTION RULES
    // =============================================
    
    // Mapeamento de usuário para oficina, público para o fluxo de login
    match /users/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Regra para o próprio documento da oficina.
    match /oficinas/{oficinaId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if false; // Nunca permitir a listagem de todas as oficinas por segurança.
        allow create: if request.auth != null;
        allow update: if isOficinaAdmin(oficinaId);
    }
    
    // Regras para os usuários/mecânicos dentro de uma oficina.
    match /oficinas/{oficinaId}/users/{userId} {
        allow get: if isOficinaMember(oficinaId);
        allow list: if oficinaId == 'dev-oficina-id' || request.auth != null;
        allow create: if isOficinaAdmin(oficinaId) || (request.auth != null && request.auth.uid == userId);
        allow delete: if isOficinaAdmin(oficinaId);
        allow update: if (isOficinaAdmin(oficinaId) || (request.auth != null && request.auth.uid == userId && request.resource.data.role == resource.data.role));
    }

    // Regras para ordens de serviço.
    match /oficinas/{oficinaId}/ordensDeServico/{osId} {
        allow get, create, update: if isOficinaMember(oficinaId);
        allow list: if oficinaId == 'dev-oficina-id' || request.auth != null;
        allow delete: if (isOficinaMember(oficinaId) && resource.data.status != 'FINALIZADO');
    }
    
    // Regras para o estoque.
    match /oficinas/{oficinaId}/inventory/{itemId} {
        allow get, create, update, delete: if isOficinaMember(oficinaId);
        allow list: if oficinaId == 'dev-oficina-id' || request.auth != null;
    }

    // Regras para transações financeiras.
    match /oficinas/{oficinaId}/financialTransactions/{transactionId} {
        allow get, write: if isOficinaAdmin(oficinaId);
        allow list: if oficinaId == 'dev-oficina-id' || request.auth != null;
    }
    
    // Regras para o histórico do veículo.
    match /oficinas/{oficinaId}/vehicleHistory/{historyId} {
      allow get, write: if isOficinaMember(oficinaId);
      allow list: if oficinaId == 'dev-oficina-id' || request.auth != null;
    }
    
    // Contadores são um mecanismo interno modificado dentro de transações por membros.
    match /oficinas/{oficinaId}/counters/{counterId} {
      allow read, write: if isOficinaMember(oficinaId);
    }

    // A configuração específica da oficina só pode ser gerenciada por administradores.
     match /oficinas/{oficinaId}/config/{configId} {
      allow read, write: if isOficinaAdmin(oficinaId);
    }
  }
}
